<template>
    <div class="constraint-studio">
        <div class="studio-container">
            <!-- Left Pane: Explorer -->
            <div class="left-pane">
                <!-- Search Bar -->
                <div class="search-container">
                    <lightning-input
                        type="search"
                        placeholder="Search..."
                        value={searchTerm}
                        onchange={handleSearchChange}
                        class="search-input">
                    </lightning-input>
                </div>
                
                <!-- Sections -->
                <div class="sections-container">
                    <template for:each={sections} for:item="section">
                        <div key={section.key} class="section">
                            <!-- Section Header -->
                            <div class="section-header">
                                <div class="section-title" data-key={section.key} onclick={handleToggleSection}>
                                    <template if:true={section.expanded}>
                                        <lightning-icon 
                                            icon-name="utility:chevrondown"
                                            size="x-small"
                                            class="section-icon">
                                        </lightning-icon>
                                    </template>
                                    <template if:false={section.expanded}>
                                        <lightning-icon 
                                            icon-name="utility:chevronright"
                                            size="x-small"
                                            class="section-icon">
                                        </lightning-icon>
                                    </template>
                                    <span class="section-label">{section.label}</span>
                                    <span class="section-count">({section.items.length})</span>
                                </div>
                                <lightning-button-icon
                                    icon-name="utility:add"
                                    variant="bare"
                                    alternative-text="Add Snippet"
                                    title="Add Snippet"
                                    data-key={section.key}
                                    onclick={handleAddSnippet}
                                    class="add-button">
                                </lightning-button-icon>
                            </div>
                            
                            <!-- Section Items -->
                            <template if:true={section.expanded}>
                                <div class="section-items">
                                    <template if:true={section.hasItems}>
                                        <template for:each={section.items} for:item="snippet">
                                            <div key={snippet.Id} class={snippet.isSelected}>
                                                <div 
                                                    class="snippet-content"
                                                    data-id={snippet.Id}
                                                    onclick={handleSnippetClick}>
                                                    <lightning-icon 
                                                        icon-name="utility:text"
                                                        size="x-small"
                                                        class="snippet-icon">
                                                    </lightning-icon>
                                                    <template if:true={snippet.Label__c}>
                                                        <span class="snippet-label">
                                                            {snippet.Label__c}
                                                        </span>
                                                    </template>
                                                    <template if:false={snippet.Label__c}>
                                                        <span class="snippet-label">
                                                            {snippet.Name}
                                                        </span>
                                                    </template>
                                                </div>
                                                <lightning-button-icon
                                                    icon-name="utility:delete"
                                                    variant="bare"
                                                    alternative-text="Delete"
                                                    title="Delete"
                                                    data-id={snippet.Id}
                                                    data-label={snippet.Label__c}
                                                    data-name={snippet.Name}
                                                    onclick={handleDeleteSnippet}
                                                    class="delete-button">
                                                </lightning-button-icon>
                                            </div>
                                        </template>
                                    </template>
                                    <template if:false={section.hasItems}>
                                        <div class="empty-section">
                                            No snippets
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Right Pane: Editor -->
            <div class="right-pane">
                <template if:true={hasSelectedSnippet}>
                    <div class="editor-container">
                        <!-- Header with Label, Active Toggle, and Save Button -->
                        <div class="editor-header">
                            <lightning-input
                                type="text"
                                value={editLabel}
                                onchange={handleLabelChange}
                                placeholder="Enter label..."
                                class="label-input">
                            </lightning-input>
                            <div class="active-toggle-container">
                                <span class="toggle-label">Active</span>
                                <lightning-input
                                    type="toggle"
                                    checked={isActive}
                                    onchange={handleActiveToggle}
                                    class="active-toggle">
                                </lightning-input>
                            </div>
                            <lightning-button
                                label="Save"
                                variant="brand"
                                onclick={handleSave}
                                disabled={isSaving}
                                class="save-button">
                            </lightning-button>
                        </div>
                        
                        <!-- CML Toggle -->
                        <div class="toggle-container">
                            <div class="toggle-wrapper">
                                <span class="toggle-label">CML</span>
                                <lightning-input
                                    type="toggle"
                                    checked={showCMLEditor}
                                    onchange={handleToggleCML}
                                    class="cml-toggle">
                                </lightning-input>
                            </div>
                        </div>
                        
                        <!-- Visual Editor (when toggle is OFF) -->
                        <template if:false={showCMLEditor}>
                            <div class="visual-editor">
                                <div class="visual-section">
                                    <div class="visual-header">
                                        <span class="visual-badge">WHEN</span>
                                        <lightning-icon 
                                            icon-name="utility:chevrondown"
                                            size="x-small">
                                        </lightning-icon>
                                    </div>
                                    <div class="visual-content">
                                        <div class="visual-row">
                                            <div class="visual-field">
                                                <label class="visual-label">* Element</label>
                                                <lightning-combobox
                                                    placeholder="Select Transaction Header"
                                                    class="visual-input"
                                                    disabled>
                                                </lightning-combobox>
                                            </div>
                                            <div class="visual-field">
                                                <label class="visual-label">Operator</label>
                                                <lightning-combobox
                                                    placeholder="Is Not Equals"
                                                    class="visual-input"
                                                    disabled>
                                                </lightning-combobox>
                                            </div>
                                            <div class="visual-field">
                                                <label class="visual-label">* Element</label>
                                                <lightning-input
                                                    type="text"
                                                    placeholder="Value = US"
                                                    class="visual-input"
                                                    disabled>
                                                </lightning-input>
                                            </div>
                                        </div>
                                        <div class="visual-info">
                                            <lightning-icon 
                                                icon-name="utility:info"
                                                size="x-small">
                                            </lightning-icon>
                                            <span class="visual-info-text">
                                                * Grouping Logic: 1
                                            </span>
                                        </div>
                                        <div class="visual-description">
                                            Group expressions within '()' and connect the groups using 'and', 'or', or 'xor' logic. When the logic contains mixed operators, always group expressions by using '()' to define the exact evaluation order.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="visual-section">
                                    <div class="visual-header">
                                        <span class="visual-badge">DISPLAY</span>
                                    </div>
                                    <div class="visual-content">
                                        <div class="visual-field">
                                            <label class="visual-label">Message Type</label>
                                            <lightning-combobox
                                                placeholder="Informational"
                                                class="visual-input"
                                                disabled>
                                            </lightning-combobox>
                                        </div>
                                        <div class="visual-field">
                                            <label class="visual-label">* Run-time Message</label>
                                            <lightning-input
                                                type="text"
                                                placeholder="Not in US"
                                                class="visual-input"
                                                disabled>
                                            </lightning-input>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Code Editor (when toggle is ON) -->
                        <template if:true={showCMLEditor}>
                            <div class="code-editor">
                    <c-cml-code-editor
                        value={editCML}
                        attribute-definitions={attributeDefinitions}
                        onchange={handleCMLChange}
                        onrequestcontext={handleContextRequest}
                        onrequestpicklist={handlePicklistRequest}>
                    </c-cml-code-editor>
                            </div>
                        </template>
                    </div>
                </template>
                
                <template if:false={hasSelectedSnippet}>
                    <div class="placeholder">
                        <div class="placeholder-content">
                            <lightning-icon 
                                icon-name="utility:text"
                                size="large"
                                class="placeholder-icon">
                            </lightning-icon>
                            <p class="placeholder-text">Select a snippet to edit or create a new one</p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</template>
